version: 2
models:
- name: chronic_conditions__tuva_chronic_conditions_long
  description: >
    This model creates one record per patient per condition using the tuva  chronic
    conditions hierarchy as the grouper. The model pulls in the first  and last date
    of the diagnosis that flagged the patient for this condition  group.
  config:
    schema: |
      {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_chronic_conditions
      {% else %}chronic_conditions{%- endif -%}
    alias: tuva_chronic_conditions_long
    tags:
    - tuva_chronic_conditions
    - chronic_conditions
    materialized: table
  tests:
  - unique:
      column_name: "(patient_id || '_' || condition)"
  columns:
  - name: patient_id
    description: The unique identifier for a patient
#        - name: condition_family
#          description: >
#            A higher level rollup grouping of conditions from the condition
#            column
#          meta:
#            terminology: https://github.com/tuva-health/the_tuva_project/blob/main/seeds/value_sets/chronic_conditions/chronic_conditions__tuva_chronic_conditions_hierarchy.csv
  - name: condition
    description: >
      The name of the condition that each diagnosis code rolls up to
    meta:
      terminology: 
        https://github.com/tuva-health/the_tuva_project/blob/main/seeds/value_sets/chronic_conditions/chronic_conditions__tuva_chronic_conditions_hierarchy.csv
  - name: first_diagnosis_date
    description: >
      The first date when a diagnosis code that rolls up to this condition  was coded
      to this patient
  - name: last_diagnosis_date
    description: >
      The last date when a diagnosis code that rolls up to this condition  was coded
      to this patient
  - name: tuva_last_run
    description: The time at with the model was materialized. Generated by `dbt_utils.pretty_time`
      as the local time of the `dbt run` environment.  Timezone is configurable via
      the `tuva_last_run` var.


